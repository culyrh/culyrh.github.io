---
layout: single        # 레이아웃 지정
title: "S3 파일 업로드 (Multipart Upload + Presigned URL)"
custom_css: custom-post
date: 2025-09-01 00:00:00
categories: []  # 카테고리
tags: [S3]                 # 태그
---

## MultipartFile 업로드


### 개념

spring에서 제공하는 MultipartFile 인터페이스를 이용하여 파일을 업로드하는 방식입니다. **큰 파일(또는 불안정한 네트워크 환경)에서 파일을 작은 조각으로 나눠 각각 업로드한 뒤, 마지막에 조각들을 합쳐서 하나의 객체로 완성합니다.**

MultipartFile Upload는 다음과 같은 이점을 가집니다.

- 병렬 업로드로 속도 향상

- 전송 실패 시 해당 파트만 재전송하므로 재개(resume)가 쉬움
(네트워크가 불안정한 환경에 적합)
  - 미완료된 파트의 경우 저장 비용이 발생할 수 있으므로 업로드 정리 필요

- 메모리/타임아웃 이슈 완화(스트리밍 방식으로 처리 가능)

![](https://velog.velcdn.com/images/rkz788/post/33099170-3557-4f43-8e6c-5072e203d1fa/image.png)

<br>

### 동작 흐름 (S3)

**1. Initiate (업로드 시작)**

- 서버(또는 클라이언트 SDK)가 **InitiateMultipartUpload** 호출 
→ 업로드를 식별할 수 있는 `uploadId(or upload session id)`를 받음.

**2. Upload Parts (각 파트 업로드)**

- 각 파트를 UploadPart API로 보낼 때 `uploadId`와 `partNumber(1,2,3...)`를 같이 보냄.

- 각 파트 업로드 성공시 서비스는 `ETag(또는 파트 체크섬)`을 반환함.

**3. List Parts (선택적)**

- 필요하면 ListParts로 현재 업로드된 파트 목록과 상태를 확인.

**4. Complete (완료 요청)**

- 모든 파트를 업로드하면 **CompleteMultipartUpload** 를 호출
→ 이 때 서비스에 `partNumber + ETag` 목록을 전송하면, 서비스가 지정된 순서(주로 partNumber 순서)대로 조립해 최종 객체를 만듬.

**5. Abort (중단/취소)**

- 업로드 도중 중단하거나 실패 시 **AbortMultipartUpload** 를 호출하여 업로드된 파트들을 정리(삭제)하고 비용/리소스 낭비를 막음.
  - 단, 한번 취소된 `Upload ID`로 다시 파트를 업로드할 수 없음.

<br>

### MultipartFile 업로드 설정

- 아래와 같은 설정으로 MultipartFile 업로드 방식을 사용합니다.

```java
spring:
  servlet:
    multipart:
      enabled: true # 멀티파트 업로드 지원여부 (default: true)
      file-size-threshold: 0B # 파일을 디스크에 저장하지 않고 메모리에 저장하는 최소 크기 (default: 0B)
      location: /users/charming/temp # 업로드된 파일이 임시로 저장되는 디스크 위치 (default: WAS가 결정)
      max-file-size: 100MB # 한개 파일의 최대 사이즈 (default: 1MB)
      max-request-size: 100MB # 한개 요청의 최대 사이즈 (default: 10MB)
```
- 업로드된 파일의 크기가 `file-size-threshold` 값 보다 크다면, **임시 디렉토리(location)**로 디스크에 저장됩니다.
  - 임시 디렉토리에 저장된 파일은 힙 메모리가 아닌 **Servlet에 저장**됩니다. 
  - 업로드 중 장애가 발생한 경우, 이 파일은 Servlet 컨테이너(Tomcat 등)가 자동으로 정리하거나, spring이 cleanup() 과정에서 삭제 처리합니다.

- 파일의 크기가 `file-size-threshold` 이하라면, WAS가 임시파일을 생성하지 않고 파일 바이너리를 **메모리(바이트 배열 버퍼)**에 다이렉트로 할당합니다.
  - 이 경우, 파일 처리 속도는 더 빠르지만 스레드가 작업을 수행하는 동안 부담이 될 수 있기 때문에 충분한 검토가 필요합니다.
  - 메모리에 저장된 업로드 데이터는 업로드 실패 시 곧바로 참조 해제되고, GC에 의해 정리됩니다.
  
  

Stream 업로드 및 MultipartFile 업로드 방식을 사용할 때 다수의 사용자로부터 동시에 요청이 들어올 경우, 서버의 스레드가 빠르게 소진될 위험이 있습니다. 이에 따라 스레드 풀 설정이 적절하지 않으면 스레드 고갈로 인해 타임아웃이 발생할 위험이 있습니다.

이러한 문제를 대비해 resilience4j의 bulkhead 패턴을 활용하여 동시에 처리될 수 있는 작업의 최대 수를 제한하고, 별도의 스레드 풀을 사용함으로써 다른 비즈니스 로직에 영향을 주지 않도록 방지할 수 있습니다. 또한 파일 업로드를 전담하는 서버를 별도로 분리하는 전략도 고려해볼 수 있습니다.

<br>

## AWS Multipart + Presigned URL


![](https://velog.velcdn.com/images/rkz788/post/d813ba02-53d6-4099-843d-76623034d187/image.png)


Multipart Upload는 AWS S3에서 제공하는 파일 업로드 방식입니다. 업로드할 파일을 작은 part로 나누어 각 부분을 개별적으로 업로드합니다. 그리고 파일의 바이너리가 Spring Boot를 거치지 않고 AWS S3에 다이렉트로 업로드되기 때문에 서버의 부하를 고려하지 않아도 된다는 큰 장점이 있습니다.

- 만약 모든 part가 업로드가 되었을 경우 AWS에서 하나의 객체로 조립하여 저장합니다.

- 또한 몇 개의 파트가 업로드되었는지 확인하여 위와 같이 사용자에게 업로드 진행사항을 제공할 수 있습니다.


Multipart Upload는 총 4단계 프로세스로 구성되어 있습니다.

1. Multipart 업로드 시작
멀티파트 업로드 시작(initiate-upload)을 요청하면 서버는 멀티파트 업로드에 대한 고유 식별자인 Upload ID를 응답합니다. 부분 업로드, 업로드 완료 또는 업로드 중단 요청 시 항상 Upload ID를 포함해야 하기 때문에 클라이언트는 이 값을 잘 저장해야 합니다.

2. PresignedURL 발급
업로드를 위한 AWS의 서명된 URL을 발급받는 요청입니다. 멀티파트 시작 요청에서 받은 Upload ID 그리고 PartNumber 값을 함께 요청해야 합니다. PartNumber는 1부터 10,000까지 파트 번호 지정이 필요합니다. AWS에서 파트 번호를 이용하여 업로드하는 객체의 각 부분과 그 위치를 고유하게 식별하기 때문입니다. 파트 번호는 연속적인 시퀀스로 선택할 필요는 없습니다 (예를 들면 1, 5 및 14를 선택해도 됩니다).

만약 이전에 업로드한 부분과 동일한 부분 번호로 새 부분을 업로드할 경우 이전에 업로드한 부분을 덮어쓰게 됩니다.

3. PresignedURL part 업로드
발급받은 PresignedURL에 PUT 메소드로 파트의 바이너리를 실어서 요청합니다. 이때 파트의 용량은 클라이언트에서 결정하여 업로드합니다.

분할된 파트는 5MB~5GB의 크기만 가능합니다. 다만 마지막 파트는 5MB 이하도 괜찮습니다. 만약 업로드할 파일의 크기가 5MB 이하라면 파트 업로드는 한번 수행되어야 합니다. 즉, 첫 번째 파트가 마지막 파트이기도 하다면 위 규칙은 위반되지 않으며 AWS S3는 멀티파트 업로드로 수락하여 객체를 생성하게 됩니다. 파트는 최대 5GB까지 10,000개까지 업로드할 수 있으니 이론상 5TB 크기의 파일까지 업로드할 수 있습니다.

파트를 업로드 후 받는 응답 헤더에 MD5 Checksum 값인 ETag(Entity Tag)가 포함되어 있습니다. 클라이언트는 각 파트 업로드 시 PartNumber와 ETag 값을 매칭하여 보관해야 합니다. 이후 멀티파트 업로드 완료 요청에 이러한 값을 포함해야 하기 때문입니다.

4. Multipart 업로드 완료
멀티파트 업로드 완료는 Upoad ID, 각 PartNumber와 매칭되는 ETag 값이 배열로 포함되어야 합니다. 업로드 완료가 수행되어야 AWS S3에서 PartNumber와 ETag를 기준으로 객체를 재조립합니다. 객체가 매우 클 경우 이 프로세스는 몇 분 정도 걸릴 수 있습니다.

만약 업로드 완료를 하지 않을 경우 S3 버킷에 파일이 생성되지 않습니다.

예외. Multipart 업로드 취소
하나 이상의 파트가 업로드된 상태에서 예기치 못한 이슈가 발생한다면 멀티파트 업로드를 완료하거나 취소해야 업로드된 파트의 스토리지 비용이 청구되지 않습니다.

따라서 클라이언트에서 예외 발생 시 멀티파트 업로드를 취소할 것을 권장 드립니다. 단, 한번 취소된 Upload ID로 다시 파트를 업로드할 수 없습니다.

위 4단계 프로세스를 클라이언트와 데이터 저장소 관점에서 정리하면 아래와 같습니다. (1, 2, 5, 6번은 Spring Boot 서버를 거치게됩니다.)


-------------


서버가 클라이언트와 S3 사이에서 중개 역할을 수행하며, 
이는 보안 및 접근 제어의 이점을 제공하지만, 추가적인 비용과 성능 부담이 발생할 수 있다.

업로드
- 클라이언트 → 서버 (Request Upload) : 사용자가 파일(이미지)을 Payload에 포함시켜 업로드 요청
- 서버 → S3 (S3 Upload, With credential) : 서버가 AWS 자격 증명을 사용하여 S3에 파일을 업로드
 
다운로드 
서버 → S3 (S3 Download, With credential) : 서버는 AWS 자격 증명을 사용하여 S3에서 파일을 다운로드
서버 → 클라이언트 (Response) : 다운로드한 파일을 클라이언트에게 반환
 

Presigned URL은 클라이언트가 IAM 인증 없이 직접 S3에 접근할 수 있도록 하는 임시 URL이다.S3의 파일을 안전하게 공유하기 위해 사용되며, 생성자의 IAM 권한을 기반으로 특정 파일에 대한 접근 권한이 부여된다.

권한을 가진 Application → Presigned URL 생성 (서명 생성)
클라이언트 → 요청 → 서버 → Presigned URL 반환 → 클라이언트는 해당 Presigned URL을 사용하여 업로드 혹은 다운로드
즉 클라이언트에서 IAM 인증 없이 직접 S3의 업로드 및 다운로드가 가능.
 특징

URL의 만료 기간 및 Method(GET/PUT)등 설정 가능
URL의 권한은 생성자가 가진 권한 중 일부 혹은 전체 사용



 
따라서 클라이언트가 임시적으로 직접 S3에 접근하는 것을 허용하여, 서버를 매개체로 할 때의 네트워크 오버헤드를 줄이면서 S3 버킷의 보안을 확보할 수 있는 방법이다.
출처: https://sjh9708.tistory.com/260 [데굴데굴 개발자의 기록:티스토리]


Presigend URL 적용하기

1. 클라이언트는 서버에 Presigned URL을 요청하여 업로드 또는 다운로드할 파일의 S3 접근 URL을 받는다.
2. 업로드 : 클라이언트는 받은 Presigned URL을 이용해 파일을 S3에 직접 PUT 요청으로 업로드한다.
3. 다운로드 : 해당 URL을 통해 S3에서 직접 파일을 가져온다.

결과적으로 서버가 파일을 직접 처리하지 않고 Presigned URL을 제공하여 클라이언트가 S3와 직접 통신할 수 있도록 하여 서버 부하를 줄이고 성능을 최적화할 수 있다.

출처: https://sjh9708.tistory.com/260 [데굴데굴 개발자의 기록:티스토리]